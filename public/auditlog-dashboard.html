
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Audit Log Dashboard</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .summary { margin-bottom: 1rem; padding: 10px; background: #fff; border: 1px solid #ddd; }
    .summary span { display: inline-block; margin-right: 20px; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 8px 12px; border: 1px solid #ccc; text-align: left; }
    th { background-color: #333; color: #fff; }
    button { padding: 8px 12px; font-size: 14px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>📋 Audit Log Dashboard</h1>
  <div class="summary" id="summaryPanel">
    <span>Total: 0</span>
    <span>Purchases: 0</span>
    <span>Consents: 0</span>
    <span>Last 24h: 0</span>
    <span>Latest: -</span>
  </div>
  <button onclick="loadLogs()">🔄 Refresh</button>
  <table id="auditLogTable">
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Event</th>
        <th>Entity</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    function summarize(logs) {
      const now = new Date();
      let total = logs.length;
      let purchases = logs.filter(e => e.eventType === 'purchase').length;
      let consents = logs.filter(e => e.eventType === 'consent').length;
      let last24h = logs.filter(e => {
        const t = new Date(e.timestamp);
        return now - t < 24 * 60 * 60 * 1000;
      }).length;
      let latest = logs.length ? new Date(logs[logs.length - 1].timestamp).toLocaleString() : "-";

      const summary = document.getElementById("summaryPanel");
      summary.innerHTML =
        "<span>Total: " + total + "</span>" +
        "<span> Purchases: " + purchases + "</span>" +
        "<span> Consents: " + consents + "</span>" +
        "<span> Last 24h: " + last24h + "</span>" +
        "<span> Latest: " + latest + "</span>";
    }

    async function loadLogs() {
      const response = await fetch('/odata/v4/loyalty/AuditLogs');
      const data = await response.json();
      console.log("🔍 Fetched logs:", data.value);
      const tableBody = document.querySelector('#auditLogTable tbody');
      tableBody.innerHTML = '';

      const sortedLogs = data.value.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      summarize(sortedLogs);

      const rows = sortedLogs.reverse().map(function(log) {
        return (
          "<tr>" +
          "<td>" + new Date(log.timestamp).toLocaleString() + "</td>" +
          "<td>" + (log.eventType || '-') + "</td>" +
          "<td>" + (log.entity || '-') + "</td>" +
          "<td><pre>" + (log.details || '-') + "</pre></td>" +
          "</tr>"
        );
      });
      tableBody.innerHTML = rows.join('');
    }

    // Initial load and auto-refresh every 15s
    loadLogs();
    setInterval(loadLogs, 15000);
  </script>
</body>
</html>
