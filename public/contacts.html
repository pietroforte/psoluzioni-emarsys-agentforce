
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Loyal Network Contacts (Fully Tagged)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f8f8; }
    input, select { margin: 5px; padding: 5px; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #333; color: #fff; }
    tr:nth-child(even) { background: #f2f2f2; }
    .pagination-controls { margin: 10px 0; }
  </style>
</head>
<body>
  <h1>üß© Network Contacts (with Segmentation)</h1>

  <div class="pagination-controls">
    <button onclick="prevPage()">‚¨ÖÔ∏è Previous</button>
    <span id="pageInfo">Page 1</span>
    <button onclick="nextPage()">Next ‚û°Ô∏è</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Name<br><input type="text" id="filterName" oninput="renderTable()"></th>
        <th>Company<br><input type="text" id="filterCompany" oninput="renderTable()"></th>
        <th>Position<br><input type="text" id="filterPosition" oninput="renderTable()"></th>
        <th>Status<br>
          <select id="filterStatus" onchange="renderTable()">
            <option value="">All</option>
            <option value="new">New</option>
            <option value="contacted">Contacted</option>
            <option value="replied">Replied</option>
            <option value="archived">Archived</option>
          </select>
        </th>
        <th>Notes<br><input type="text" id="filterNotes" oninput="renderTable()"></th>
        <th>Priority<br>
          <select id="filterPriority" onchange="renderTable()">
            <option value="">All</option>
            <option value="true">‚úÖ</option>
            <option value="false">‚ùå</option>
          </select>
        </th>
        <th>Senior<br>
          <select id="filterSenior" onchange="renderTable()">
            <option value="">All</option>
            <option value="true">‚≠ê</option>
            <option value="false">‚ùå</option>
          </select>
        </th>
        <th>Score<br>
          <input type="number" id="filterScoreMin" placeholder="min" oninput="renderTable()" style="width: 45px;">
          <input type="number" id="filterScoreMax" placeholder="max" oninput="renderTable()" style="width: 45px;">
        </th>
        <th>Roles<br><input type="text" id="filterRoles" oninput="renderTable()"></th>
        <th>Segments<br><input type="text" id="filterSegments" oninput="renderTable()"></th>
        <th>LinkedIn</th>
      </tr>
    </thead>
    <tbody id="contactsTable"></tbody>
  </table>

  <script>
    let contacts = [], currentPage = 1, pageSize = 50, filteredContacts = [];

    async function fetchAllContacts(url, acc = []) {
      const res = await fetch(url);
      const json = await res.json();
      const all = acc.concat(json.value || []);
      if (json["@odata.nextLink"]) {
        let next = json["@odata.nextLink"];
        if (!next.startsWith("http")) {
          next = '/odata/v4/loyalty/' + next;
        }
        return fetchAllContacts(next, all);
      }
      return all;
    }

    async function loadContacts() {
      contacts = await fetchAllContacts('/odata/v4/loyalty/NetworkContacts');
      contacts.sort((a, b) => (b.relevanceScore || 0) - (a.relevanceScore || 0));
      renderTable();
    }

    function getFilterValue(id) {
      const el = document.getElementById(id);
      return el ? el.value.toLowerCase() : '';
    }

    function getNumericValue(id) {
      const val = document.getElementById(id).value;
      return val ? parseInt(val) : null;
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    }

    function nextPage() {
      if (currentPage * pageSize < filteredContacts.length) {
        currentPage++;
        renderTable();
      }
    }

    function renderTable() {
      const name = getFilterValue("filterName");
      const company = getFilterValue("filterCompany");
      const position = getFilterValue("filterPosition");
      const status = getFilterValue("filterStatus");
      const notes = getFilterValue("filterNotes");
      const priority = getFilterValue("filterPriority");
      const senior = getFilterValue("filterSenior");
      const scoreMin = getNumericValue("filterScoreMin");
      const scoreMax = getNumericValue("filterScoreMax");
      const roles = getFilterValue("filterRoles");
      const segments = getFilterValue("filterSegments");

      filteredContacts = contacts.filter(c =>
        (!name || ((c.firstName + ' ' + c.lastName).toLowerCase().includes(name))) &&
        (!company || (c.company && c.company.toLowerCase().includes(company))) &&
        (!position || (c.position && c.position.toLowerCase().includes(position))) &&
        (!status || c.status === status) &&
        (!notes || (c.notes && c.notes.toLowerCase().includes(notes))) &&
        (!priority || String(c.isPriorityCompany) === priority) &&
        (!senior || String(c.isSenior) === senior) &&
        (scoreMin === null || (c.relevanceScore >= scoreMin)) &&
        (scoreMax === null || (c.relevanceScore <= scoreMax)) &&
        (!roles || (c.contactRoles && c.contactRoles.toLowerCase().includes(roles))) &&
        (!segments || (c.campaignSegments && c.campaignSegments.toLowerCase().includes(segments)))
      );

      const pageInfo = document.getElementById("pageInfo");
      pageInfo.innerText = `Page ${currentPage} of ${Math.ceil(filteredContacts.length / pageSize)}`;

      const pageStart = (currentPage - 1) * pageSize;
      const pageEnd = pageStart + pageSize;
      const pageContacts = filteredContacts.slice(pageStart, pageEnd);

      const table = document.getElementById("contactsTable");
      table.innerHTML = "";
      pageContacts.forEach(c => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${c.firstName} ${c.lastName}</td>
          <td>${c.company || ''}</td>
          <td>${c.position || ''}</td>
          <td>${c.status || ''}</td>
          <td>${c.notes || ''}</td>
          <td>${c.isPriorityCompany ? '‚úÖ' : '‚ùå'}</td>
          <td>${c.isSenior ? '‚≠ê' : '‚ùå'}</td>
          <td>${c.relevanceScore ?? ''}</td>
          <td>${c.contactRoles || ''}</td>
          <td>${c.campaignSegments || ''}</td>
          <td><a href="${c.linkedin}" target="_blank">View</a></td>
        `;
        table.appendChild(row);
      });
    }

    loadContacts();
  </script>
</body>
</html>
